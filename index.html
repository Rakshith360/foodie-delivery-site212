<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foodie Express</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.js"></script>
    
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .animate-slide-in {
            animation: slide-in 0.7s ease-out forwards;
        }
        @keyframes slide-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Loading Spinner Overlay -->
    <div id="loader" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-orange-500"></div>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" id="home-link" class="text-2xl font-bold text-orange-500 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                        Foodie Express
                    </a>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#" id="menu-link-desktop" class="text-gray-600 dark:text-gray-300 hover:text-orange-500 dark:hover:text-orange-400 px-3 py-2 rounded-md text-sm font-medium">Menu</a>
                        <!-- More links can be added here -->
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="relative mr-4">
                        <input type="search" id="search-bar" placeholder="Search food..." class="bg-gray-100 dark:bg-gray-700 h-10 px-5 pr-10 rounded-full text-sm focus:outline-none w-32 md:w-48 transition-all duration-300">
                         <button type="submit" class="absolute right-0 top-0 mt-3 mr-4">
                            <svg class="text-gray-600 dark:text-gray-400 h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        </button>
                    </div>

                    <button id="theme-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                        <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                    
                    <button id="cart-button" class="ml-4 relative p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                        <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                    </button>

                    <div id="auth-container" class="ml-4">
                        <!-- Auth buttons will be rendered here -->
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Home Page -->
        <section id="home-page" class="page">
            <div class="relative rounded-lg overflow-hidden mb-12">
                <div class="absolute inset-0 bg-gradient-to-r from-black via-transparent to-black opacity-50"></div>
                <img src="https://placehold.co/1200x500/FFF4E0/333333?text=Delicious+Food+Awaits" class="w-full h-64 md:h-96 object-cover" alt="Hero banner">
                <div class="absolute inset-0 flex flex-col items-center justify-center text-white text-center p-4">
                    <h1 id="hero-title" class="text-4xl md:text-6xl font-extrabold mb-4 animate-slide-in" style="animation-delay: 0.2s;">Your Favorite Food, Delivered Fast</h1>
                    <p id="hero-subtitle" class="text-lg md:text-xl mb-8 animate-slide-in" style="animation-delay: 0.4s;">Order from the best restaurants near you.</p>
                    <button id="order-now-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 transform hover:scale-105 animate-slide-in" style="animation-delay: 0.6s;">Order Now</button>
                </div>
            </div>

            <!-- Menu Preview Section -->
            <div id="menu-page">
                <h2 class="text-3xl font-bold text-center mb-8">Our Menu</h2>
                <div id="menu-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    <!-- Menu items will be dynamically inserted here -->
                </div>
            </div>
        </section>

        <!-- Auth Page -->
        <section id="auth-page" class="page hidden max-w-md mx-auto">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg">
                <div class="flex mb-6 border-b border-gray-300 dark:border-gray-600">
                    <button id="login-tab" class="flex-1 py-2 text-center font-semibold text-orange-500 border-b-2 border-orange-500">Login</button>
                    <button id="signup-tab" class="flex-1 py-2 text-center font-semibold text-gray-500 dark:text-gray-400">Sign Up</button>
                </div>

                <!-- Login Form -->
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="login-email" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg border focus:border-orange-500 focus:outline-none" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg border focus:border-orange-500 focus:outline-none" required>
                    </div>
                    <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Login</button>
                </form>

                <!-- Signup Form -->
                <form id="signup-form" class="hidden">
                    <div class="mb-4">
                        <label for="signup-name" class="block text-sm font-medium mb-1">Full Name</label>
                        <input type="text" id="signup-name" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg border focus:border-orange-500 focus:outline-none" required>
                    </div>
                    <div class="mb-4">
                        <label for="signup-email" class="block text-sm font-medium mb-1">Email</label>
                        <input type="email" id="signup-email" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg border focus:border-orange-500 focus:outline-none" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="signup-password" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg border focus:border-orange-500 focus:outline-none" required>
                    </div>
                    <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Create Account</button>
                </form>

                <!-- Social Login Separator -->
                <div class="mt-6">
                    <div class="relative">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">
                                Or continue with
                            </span>
                        </div>
                    </div>
        
                    <!-- Google Sign-In Button -->
                    <div class="mt-6">
                        <button id="google-signin-btn" class="w-full flex items-center justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                            <svg class="w-5 h-5 mr-3" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 110.3 512 0 401.7 0 265.4 0 129.1 110.3 20 244 20c66.2 0 123.4 25.8 166.4 68.6l-67.4 64.8C291.1 94.3 268.6 80 244 80c-73.2 0-132.3 59.9-132.3 133.4s59.1 133.4 132.3 133.4c76.9 0 115.3-52.8 120.3-80.4H244V261.8h244z"></path></svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Cart Page -->
        <section id="cart-page" class="page hidden">
             <h2 class="text-3xl font-bold mb-6">Your Cart</h2>
             <div class="lg:flex lg:space-x-8">
                 <div id="cart-items-container" class="flex-grow">
                    <!-- Cart items will be rendered here -->
                 </div>
                 <div id="checkout-section" class="w-full lg:w-1/3 mt-8 lg:mt-0">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Order Summary</h3>
                        <div class="flex justify-between mb-2">
                            <span>Subtotal</span>
                            <span id="cart-subtotal">$0.00</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>Delivery Fee</span>
                            <span>$2.00</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg border-t pt-2">
                            <span>Total</span>
                            <span id="cart-total">$0.00</span>
                        </div>
                        <hr class="my-4">
                        <form id="checkout-form">
                            <h4 class="font-semibold mb-2">Delivery Details</h4>
                            <div class="mb-2">
                                <label for="checkout-name" class="text-sm">Name</label>
                                <input type="text" id="checkout-name" class="w-full p-2 mt-1 bg-gray-100 dark:bg-gray-700 rounded-md border focus:border-orange-500 focus:outline-none" required>
                            </div>
                             <div class="mb-2">
                                <label for="checkout-address" class="text-sm">Address</label>
                                <input type="text" id="checkout-address" class="w-full p-2 mt-1 bg-gray-100 dark:bg-gray-700 rounded-md border focus:border-orange-500 focus:outline-none" required>
                            </div>
                             <div class="mb-4">
                                <label for="checkout-phone" class="text-sm">Phone</label>
                                <input type="tel" id="checkout-phone" class="w-full p-2 mt-1 bg-gray-100 dark:bg-gray-700 rounded-md border focus:border-orange-500 focus:outline-none" required>
                            </div>
                            <button id="place-order-btn" type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Place Order</button>
                        </form>
                    </div>
                 </div>
             </div>
        </section>

        <!-- Profile Page -->
        <section id="profile-page" class="page hidden max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold mb-6">Your Profile</h2>
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
                <div id="user-info" class="mb-8">
                    <!-- User info will be here -->
                </div>
                <h3 class="text-2xl font-semibold mb-4">Order History</h3>
                <div id="order-history-container" class="space-y-4">
                   <!-- Order history will be populated here -->
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 dark:bg-gray-900 text-white mt-12">
        <div class="container mx-auto px-6 py-4 text-center">
            <p>&copy; 2025 Foodie Express. All Rights Reserved.</p>
        </div>
    </footer>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        // IMPORTANT: Replace the placeholder values below with your actual
        // Firebase project's configuration. You can find this in your
        // Firebase project settings under "General".
        const firebaseConfig = {
            apiKey: "AIzaSyB1hy_cOH3rlxEVQl3AGvnpJpFoC-a2Zng",
  authDomain: "foodie-delivery-site-1212.firebaseapp.com",
  projectId: "foodie-delivery-site-1212",
  storageBucket: "foodie-delivery-site-1212.firebasestorage.app",
  messagingSenderId: "1069261462305",
  appId: "1:1069261462305:web:bb1206ce8d42529f55bc60"
        };
        
        // This variable is usually provided in a special environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'foodie-express-app';

        // Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // EmailJS Config - Replace with your own IDs
        const EMAILJS_SERVICE_ID = 'service_foodie_express';
        const EMAILJS_TEMPLATE_ID = 'template_order_confirmation';
        const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY'; // Replace with your EmailJS Public Key

        // DOM Elements
        const loader = document.getElementById('loader');
        const pages = document.querySelectorAll('.page');
        const authContainer = document.getElementById('auth-container');
        const cartCount = document.getElementById('cart-count');
        const searchBar = document.getElementById('search-bar');
        const menuContainer = document.getElementById('menu-container');

        // App State
        let currentUser = null;
        let cart = [];
        let menuItems = [];

        // --- UTILITY FUNCTIONS ---
        const showLoader = () => loader.classList.remove('hidden');
        const hideLoader = () => loader.classList.add('hidden');

        const showToast = (title, icon = 'success') => {
            Swal.fire({
                title: title,
                icon: icon,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            });
        };

        const showPage = (pageId) => {
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });
            window.scrollTo(0, 0);
        };
        
        // --- THEME MANAGEMENT ---
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            }
        };

        themeToggle.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.toggle('dark');
            const theme = isDarkMode ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        });

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            currentUser = user;
            updateUIForAuthState();
            if(user) {
                // If user is logged in and on the auth page, redirect to home
                if (!document.getElementById('auth-page').classList.contains('hidden')) {
                    showPage('home-page');
                }
            }
        });

        const updateUIForAuthState = () => {
            if (currentUser) {
                authContainer.innerHTML = `
                    <button id="profile-button" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </button>
                    <button id="logout-button" class="ml-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md text-sm transition duration-300">Logout</button>
                `;
                document.getElementById('profile-button').addEventListener('click', () => showProfilePage());
                document.getElementById('logout-button').addEventListener('click', handleLogout);
            } else {
                authContainer.innerHTML = `
                    <button id="login-nav-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-md text-sm transition duration-300">Login</button>
                `;
                document.getElementById('login-nav-button').addEventListener('click', () => showPage('auth-page'));
            }
        };
        
        // --- CART MANAGEMENT ---
        const loadCartFromStorage = () => {
            const storedCart = localStorage.getItem('foodieExpressCart');
            cart = storedCart ? JSON.parse(storedCart) : [];
            updateCartUI();
        };

        const saveCartToStorage = () => {
            localStorage.setItem('foodieExpressCart', JSON.stringify(cart));
        };

        const updateCartUI = () => {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartCount.textContent = totalItems;
            renderCartPage();
            updateCartTotals();
        };
        
        const addToCart = (itemId) => {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;

            const cartItem = cart.find(i => i.id === itemId);
            if(cartItem) {
                cartItem.quantity++;
            } else {
                cart.push({ ...item, quantity: 1 });
            }
            showToast(`${item.name} added to cart!`);
            saveCartToStorage();
            updateCartUI();
        };
        
        // --- NAVIGATION & EVENT LISTENERS ---
        document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); showPage('home-page'); });
        document.getElementById('menu-link-desktop').addEventListener('click', (e) => { e.preventDefault(); showPage('home-page'); document.getElementById('menu-page').scrollIntoView(); });
        document.getElementById('order-now-btn').addEventListener('click', () => { document.getElementById('menu-page').scrollIntoView(); });
        document.getElementById('cart-button').addEventListener('click', () => { showPage('cart-page'); });
        
        // Auth Page Tabs
        const loginTab = document.getElementById('login-tab');
        const signupTab = document.getElementById('signup-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');

        loginTab.addEventListener('click', () => {
            loginTab.classList.add('text-orange-500', 'border-orange-500');
            loginTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            signupTab.classList.remove('text-orange-500', 'border-orange-500');
            signupTab.classList.add('text-gray-500', 'dark:text-gray-400');
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
        });
        
        signupTab.addEventListener('click', () => {
            signupTab.classList.add('text-orange-500', 'border-orange-500');
            signupTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            loginTab.classList.remove('text-orange-500', 'border-orange-500');
            loginTab.classList.add('text-gray-500', 'dark:text-gray-400');
            signupForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
        });
        
        // Auth Form Submissions
        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignup);
        document.getElementById('checkout-form').addEventListener('submit', handlePlaceOrder);
        document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);

        // Search
        searchBar.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredItems = menuItems.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.category.toLowerCase().includes(searchTerm)
            );
            renderMenu(filteredItems);
        });

        // --- PAGE RENDERING ---
        
        const renderMenu = (itemsToRender) => {
            if (!menuContainer) return;
            menuContainer.innerHTML = '';
            if (itemsToRender.length === 0) {
                 menuContainer.innerHTML = `<p class="text-center col-span-full">No menu items found. The kitchen might be updating the menu!</p>`;
                 return;
            }
            itemsToRender.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden transform hover:scale-105 transition-transform duration-300';
                card.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-xl font-bold">${item.name}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">${item.category}</p>
                        <p class="text-gray-600 dark:text-gray-300 mb-4">${item.description}</p>
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-bold text-orange-500">$${item.price.toFixed(2)}</span>
                            <button class="add-to-cart-btn bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-colors" data-id="${item.id}">Add to Cart</button>
                        </div>
                    </div>
                `;
                menuContainer.appendChild(card);
            });

            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.getAttribute('data-id');
                    addToCart(itemId);
                });
            });
        };
        
        const renderCartPage = () => {
            const container = document.getElementById('cart-items-container');
            const checkoutSection = document.getElementById('checkout-section');
            if (!container) return;
            
            if (cart.length === 0) {
                container.innerHTML = `<div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md text-center">
                    <h3 class="text-2xl font-semibold mb-2">Your cart is empty</h3>
                    <p class="text-gray-500 dark:text-gray-400 mb-6">Looks like you haven't added anything to your cart yet.</p>
                    <button id="browse-menu-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg">Browse Menu</button>
                </div>`;
                checkoutSection.classList.add('hidden');
                document.getElementById('browse-menu-btn').addEventListener('click', () => showPage('home-page'));
            } else {
                checkoutSection.classList.remove('hidden');
                container.innerHTML = cart.map(item => `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex items-center mb-4" data-id="${item.id}">
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-20 h-20 object-cover rounded-md mr-4">
                        <div class="flex-grow">
                            <h4 class="font-semibold">${item.name}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">$${item.price.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center">
                            <button class="quantity-change bg-gray-200 dark:bg-gray-700 p-1 rounded-full" data-action="decrease">-</button>
                            <span class="mx-4 font-semibold">${item.quantity}</span>
                            <button class="quantity-change bg-gray-200 dark:bg-gray-700 p-1 rounded-full" data-action="increase">+</button>
                        </div>
                        <div class="text-right ml-4 w-20">
                            <p class="font-bold">$${(item.price * item.quantity).toFixed(2)}</p>
                        </div>
                        <button class="remove-from-cart ml-4 text-red-500 hover:text-red-700">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `).join('');
                addCartEventListeners();
            }
        };

        const addCartEventListeners = () => {
             document.querySelectorAll('.quantity-change').forEach(button => {
                button.addEventListener('click', e => {
                    const id = e.target.closest('[data-id]').dataset.id;
                    const action = e.target.dataset.action;
                    updateCartQuantity(id, action);
                });
            });
            document.querySelectorAll('.remove-from-cart').forEach(button => {
                button.addEventListener('click', e => {
                    const id = e.target.closest('[data-id]').dataset.id;
                    removeFromCart(id);
                });
            });
        };
        
        const updateCartQuantity = (id, action) => {
            const itemIndex = cart.findIndex(i => i.id === id);
            if (itemIndex === -1) return;
            
            if (action === 'increase') {
                cart[itemIndex].quantity++;
            } else if (action === 'decrease') {
                cart[itemIndex].quantity--;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1);
                }
            }
            saveCartToStorage();
            updateCartUI();
        };

        const removeFromCart = (id) => {
             cart = cart.filter(item => item.id !== id);
             saveCartToStorage();
             updateCartUI();
             showToast('Item removed from cart', 'info');
        };

        const updateCartTotals = () => {
            const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const deliveryFee = cart.length > 0 ? 2.00 : 0;
            const total = subtotal + deliveryFee;

            document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
        };

        const showProfilePage = async () => {
            if (!currentUser) {
                showToast('Please login to view your profile.', 'warning');
                showPage('auth-page');
                return;
            }
            showPage('profile-page');
            showLoader();

            // Render User Info
            const userInfoContainer = document.getElementById('user-info');
            userInfoContainer.innerHTML = `
                <p><strong>Name:</strong> ${currentUser.displayName || 'Not set'}</p>
                <p><strong>Email:</strong> ${currentUser.email}</p>
            `;

            // Render Order History
            const orderHistoryContainer = document.getElementById('order-history-container');
            orderHistoryContainer.innerHTML = '';
            try {
                const ordersPath = `/artifacts/${appId}/users/${currentUser.uid}/orders`;
                const q = query(collection(db, ordersPath));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    orderHistoryContainer.innerHTML = '<p>You have no past orders.</p>';
                } else {
                    let orders = [];
                    querySnapshot.forEach((doc) => {
                        orders.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort orders by date descending in JS
                    orders.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                    orders.forEach(order => {
                        const orderCard = document.createElement('div');
                        orderCard.className = 'border dark:border-gray-700 p-4 rounded-lg';
                        orderCard.innerHTML = `
                            <div class="flex justify-between items-center">
                                <p class="font-semibold">Order ID: ${order.id.substring(0, 8)}</p>
                                <p class="text-sm text-gray-500">${order.createdAt.toDate().toLocaleString()}</p>
                            </div>
                            <p>Total: <span class="font-bold">$${order.total.toFixed(2)}</span></p>
                            <p>Status: <span class="text-green-500 font-semibold">${order.status}</span></p>
                            <div class="mt-2 text-sm">
                                ${order.items.map(item => `
                                    <p>${item.quantity} x ${item.name}</p>
                                `).join('')}
                            </div>
                        `;
                        orderHistoryContainer.appendChild(orderCard);
                    });
                }
            } catch (error) {
                console.error("Error fetching order history:", error);
                orderHistoryContainer.innerHTML = '<p class="text-red-500">Could not fetch order history.</p>';
            } finally {
                hideLoader();
            }
        };

        // --- HANDLER FUNCTIONS ---
        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            showLoader();
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                
                // Create a user document in Firestore
                const userDocRef = doc(db, `artifacts/${appId}/users`, userCredential.user.uid);
                await setDoc(userDocRef, {
                    name: name,
                    email: email,
                    createdAt: new Date()
                });

                showToast('Account created successfully!', 'success');
                showPage('home-page');
            } catch (error) {
                console.error("Signup error: ", error);
                showToast(error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            showLoader();
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Logged in successfully!', 'success');
                showPage('home-page');
            } catch (error) {
                console.error("Login error: ", error);
                showToast(error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            showLoader();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Check if user exists in Firestore, if not, create a document
                const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists()) {
                    // New user, create their document
                    await setDoc(userDocRef, {
                        name: user.displayName,
                        email: user.email,
                        createdAt: new Date()
                    });
                }
                
                showToast('Signed in with Google successfully!', 'success');
                showPage('home-page');
            } catch (error) {
                console.error("Google Sign-In error: ", error);
                 if (error.code !== 'auth/popup-closed-by-user') {
                     showToast(error.message, 'error');
                }
            } finally {
                hideLoader();
            }
        }

        async function handleLogout() {
            showLoader();
            try {
                await signOut(auth);
                showToast('Logged out successfully.', 'info');
                showPage('home-page');
            } catch(error) {
                console.error("Logout error: ", error);
                showToast(error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        async function handlePlaceOrder(e) {
            e.preventDefault();
            if (!currentUser) {
                showToast('Please login to place an order.', 'warning');
                showPage('auth-page');
                return;
            }

            if (cart.length === 0) {
                showToast('Your cart is empty.', 'info');
                return;
            }
            
            showLoader();
            const name = document.getElementById('checkout-name').value;
            const address = document.getElementById('checkout-address').value;
            const phone = document.getElementById('checkout-phone').value;
            
            const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const deliveryFee = 2.00;
            const total = subtotal + deliveryFee;

            const order = {
                userId: currentUser.uid,
                customerName: name,
                customerEmail: currentUser.email,
                address: address,
                phone: phone,
                items: cart,
                subtotal: subtotal,
                total: total,
                status: 'Placed',
                createdAt: new Date()
            };

            try {
                // Save order to Firestore
                const ordersCollectionPath = `/artifacts/${appId}/users/${currentUser.uid}/orders`;
                await addDoc(collection(db, ordersCollectionPath), order);

                // Send email notification with EmailJS
                await sendOrderEmail(order);
                
                showToast('Order placed successfully!', 'success');
                cart = [];
                saveCartToStorage();
                updateCartUI();
                showProfilePage();
            } catch (error) {
                console.error("Error placing order:", error);
                showToast('Failed to place order. Please try again.', 'error');
            } finally {
                hideLoader();
            }
        }
        
        // --- DATA FETCHING ---
        const fetchMenu = async () => {
            showLoader();
            // Using a hardcoded menu. In a real app, this would fetch from Firestore.
            // Example of fetching from firestore:
            // const querySnapshot = await getDocs(collection(db, "menu"));
            // querySnapshot.forEach((doc) => { menuItems.push({ id: doc.id, ...doc.data() }); });
            
            menuItems = [
                 { id: 'item1', name: 'Margherita Pizza', category: 'Pizza', description: 'Classic cheese and tomato pizza.', price: 12.99, imageUrl: 'https://placehold.co/400x300/FFC107/000000?text=Pizza' },
                 { id: 'item2', name: 'Cheeseburger', category: 'Burgers', description: 'Juicy beef patty with cheese.', price: 8.99, imageUrl: 'https://placehold.co/400x300/4CAF50/FFFFFF?text=Burger' },
                 { id: 'item3', name: 'Caesar Salad', category: 'Salads', description: 'Fresh greens with Caesar dressing.', price: 7.50, imageUrl: 'https://placehold.co/400x300/8BC34A/000000?text=Salad' },
                 { id: 'item4', name: 'Spaghetti Carbonara', category: 'Pasta', description: 'Creamy pasta with bacon.', price: 14.00, imageUrl: 'https://placehold.co/400x300/CDDC39/000000?text=Pasta' },
                 { id: 'item5', name: 'Sushi Platter', category: 'Sushi', description: 'Assortment of fresh sushi.', price: 22.50, imageUrl: 'https://placehold.co/400x300/F44336/FFFFFF?text=Sushi' },
                 { id: 'item6', name: 'Chocolate Lava Cake', category: 'Desserts', description: 'Warm cake with a molten center.', price: 6.99, imageUrl: 'https://placehold.co/400x300/607D8B/FFFFFF?text=Dessert' },
                 { id: 'item7', name: 'Chicken Wings', category: 'Appetizers', description: 'Spicy and crispy chicken wings.', price: 9.99, imageUrl: 'https://placehold.co/400x300/FF9800/000000?text=Wings' },
                 { id: 'item8', name: 'Iced Coffee', category: 'Drinks', description: 'Refreshing cold brew coffee.', price: 3.50, imageUrl: 'https://placehold.co/400x300/795548/FFFFFF?text=Coffee' },
            ];
            
            renderMenu(menuItems);
            hideLoader();
        };

        // --- EMAILJS INTEGRATION ---
        const sendOrderEmail = (order) => {
            // Check if public key is set
            if(EMAILJS_PUBLIC_KEY === '4omNU308mvl1wWirS') {
                console.warn("EmailJS Public Key not set. Skipping email notification.");
                return Promise.resolve(); // Resolve promise to not block order placement
            }

            try {
                emailjs.init(EMAILJS_PUBLIC_KEY);
            } catch(e) {
                console.error("EmailJS init error:", e);
                return Promise.reject(e);
            }
            
            const templateParams = {
                admin_email: 'pipparirakshith92@gmail.com', // Admin's email
                user_name: order.customerName,
                user_email: order.customerEmail,
                user_address: order.address,
                order_total: `$${order.total.toFixed(2)}`,
                order_details: order.items.map(item => `${item.quantity} x ${item.name}`).join('\n')
            };

            return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
                .then(response => {
                    console.log('EmailJS SUCCESS!', response.status, response.text);
                }, error => {
                    console.log('EmailJS FAILED...', error);
                    // Don't show an error to the user, just log it. The order is already placed.
                });
        };
        
        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            loadCartFromStorage();
            fetchMenu();
            showPage('home-page');
        });

    </script>
</body>
</html>

